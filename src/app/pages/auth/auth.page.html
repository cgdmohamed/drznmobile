<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title *ngIf="authMode === 'login'">Login</ion-title>
    <ion-title *ngIf="authMode === 'register'">Create Account</ion-title>
    <ion-title *ngIf="authMode === 'forgot-password'">Reset Password</ion-title>
    <ion-title *ngIf="authMode === 'verify-otp'">Verify OTP</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="auth-container">
    <!-- App logo -->
    <div class="logo-container">
      <img src="assets/logo.png" alt="App Logo" class="app-logo">
    </div>

    <!-- Login form -->
    <div *ngIf="authMode === 'login'">
      <h2 class="auth-title">Welcome Back</h2>
      <p class="auth-subtitle">Sign in to your account</p>

      <form [formGroup]="loginForm" (ngSubmit)="onLogin()">
        <ion-item class="auth-input">
          <ion-label position="floating">Email</ion-label>
          <ion-input type="email" formControlName="email"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="loginForm.get('email')?.invalid && loginForm.get('email')?.touched">
          <span *ngIf="loginForm.get('email')?.errors?.['required']">Email is required</span>
          <span *ngIf="loginForm.get('email')?.errors?.['email']">Please enter a valid email</span>
        </div>

        <ion-item class="auth-input">
          <ion-label position="floating">Password</ion-label>
          <ion-input [type]="passwordVisible ? 'text' : 'password'" formControlName="password"></ion-input>
          <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility('password')">
            <ion-icon [name]="passwordVisible ? 'eye-off' : 'eye'"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="validation-error" *ngIf="loginForm.get('password')?.invalid && loginForm.get('password')?.touched">
          <span *ngIf="loginForm.get('password')?.errors?.['required']">Password is required</span>
          <span *ngIf="loginForm.get('password')?.errors?.['minlength']">Password must be at least 6 characters</span>
        </div>

        <div class="forgot-password">
          <a (click)="switchMode('forgot-password')">Forgot Password?</a>
        </div>

        <ion-button expand="block" type="submit" [disabled]="loginForm.invalid || isLoading" class="auth-button">
          <span *ngIf="!isLoading">Login</span>
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        </ion-button>
      </form>

      <div class="auth-footer">
        <p>Don't have an account? <a (click)="switchMode('register')">Sign Up</a></p>
      </div>
    </div>

    <!-- Register form -->
    <div *ngIf="authMode === 'register'">
      <h2 class="auth-title">Create Account</h2>
      <p class="auth-subtitle">Sign up to get started</p>

      <form [formGroup]="registerForm" (ngSubmit)="onRegister()">
        <ion-item class="auth-input">
          <ion-label position="floating">Email</ion-label>
          <ion-input type="email" formControlName="email"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
          <span *ngIf="registerForm.get('email')?.errors?.['required']">Email is required</span>
          <span *ngIf="registerForm.get('email')?.errors?.['email']">Please enter a valid email</span>
        </div>

        <ion-item class="auth-input">
          <ion-label position="floating">Username</ion-label>
          <ion-input type="text" formControlName="username"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('username')?.invalid && registerForm.get('username')?.touched">
          <span *ngIf="registerForm.get('username')?.errors?.['required']">Username is required</span>
          <span *ngIf="registerForm.get('username')?.errors?.['minlength']">Username must be at least 3 characters</span>
        </div>

        <ion-item class="auth-input">
          <ion-label position="floating">Mobile Number (with country code)</ion-label>
          <ion-input type="tel" formControlName="mobile" placeholder="e.g. +966501234567"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('mobile')?.invalid && registerForm.get('mobile')?.touched">
          <span *ngIf="registerForm.get('mobile')?.errors?.['required']">Mobile number is required</span>
          <span *ngIf="registerForm.get('mobile')?.errors?.['pattern']">Please enter a valid mobile number with country code</span>
        </div>

        <ion-item class="auth-input">
          <ion-label position="floating">Password</ion-label>
          <ion-input [type]="passwordVisible ? 'text' : 'password'" formControlName="password"></ion-input>
          <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility('password')">
            <ion-icon [name]="passwordVisible ? 'eye-off' : 'eye'"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched">
          <span *ngIf="registerForm.get('password')?.errors?.['required']">Password is required</span>
          <span *ngIf="registerForm.get('password')?.errors?.['minlength']">Password must be at least 6 characters</span>
        </div>

        <ion-item class="auth-input">
          <ion-label position="floating">Confirm Password</ion-label>
          <ion-input [type]="confirmPasswordVisible ? 'text' : 'password'" formControlName="confirmPassword"></ion-input>
          <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility('confirmPassword')">
            <ion-icon [name]="confirmPasswordVisible ? 'eye-off' : 'eye'"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('confirmPassword')?.invalid && registerForm.get('confirmPassword')?.touched">
          <span *ngIf="registerForm.get('confirmPassword')?.errors?.['required']">Please confirm your password</span>
        </div>
        <div class="validation-error" *ngIf="registerForm.hasError('notMatching') && registerForm.get('confirmPassword')?.touched">
          <span>Passwords do not match</span>
        </div>

        <ion-item lines="none" class="terms-checkbox">
          <ion-checkbox formControlName="acceptTerms"></ion-checkbox>
          <ion-label>I accept the <a>Terms and Conditions</a></ion-label>
        </ion-item>
        <div class="validation-error" *ngIf="registerForm.get('acceptTerms')?.invalid && registerForm.get('acceptTerms')?.touched">
          <span>You must accept the terms and conditions</span>
        </div>

        <ion-button expand="block" type="submit" [disabled]="registerForm.invalid || isLoading" class="auth-button">
          <span *ngIf="!isLoading">Register</span>
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        </ion-button>
      </form>

      <div class="auth-footer">
        <p>Already have an account? <a (click)="switchMode('login')">Sign In</a></p>
      </div>
    </div>

    <!-- Forgot password form -->
    <div *ngIf="authMode === 'forgot-password'">
      <h2 class="auth-title">Reset Password</h2>
      <p class="auth-subtitle">Enter your email to reset your password</p>

      <form [formGroup]="forgotPasswordForm" (ngSubmit)="onForgotPassword()">
        <ion-item class="auth-input">
          <ion-label position="floating">Email</ion-label>
          <ion-input type="email" formControlName="email"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="forgotPasswordForm.get('email')?.invalid && forgotPasswordForm.get('email')?.touched">
          <span *ngIf="forgotPasswordForm.get('email')?.errors?.['required']">Email is required</span>
          <span *ngIf="forgotPasswordForm.get('email')?.errors?.['email']">Please enter a valid email</span>
        </div>

        <ion-button expand="block" type="submit" [disabled]="forgotPasswordForm.invalid || isLoading" class="auth-button">
          <span *ngIf="!isLoading">Reset Password</span>
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        </ion-button>
      </form>

      <div class="auth-footer">
        <p>Remember your password? <a (click)="switchMode('login')">Back to Login</a></p>
      </div>
    </div>

    <!-- OTP verification form -->
    <div *ngIf="authMode === 'verify-otp'">
      <h2 class="auth-title">Verify OTP</h2>
      <p class="auth-subtitle">Enter the OTP sent to your mobile</p>

      <form [formGroup]="resetPasswordForm" (ngSubmit)="verifyOtpAndRegister()">
        <ion-item class="auth-input">
          <ion-label position="floating">OTP Code</ion-label>
          <ion-input type="number" formControlName="otp"></ion-input>
        </ion-item>
        <div class="validation-error" *ngIf="resetPasswordForm.get('otp')?.invalid && resetPasswordForm.get('otp')?.touched">
          <span *ngIf="resetPasswordForm.get('otp')?.errors?.['required']">OTP is required</span>
          <span *ngIf="resetPasswordForm.get('otp')?.errors?.['pattern']">Please enter a valid OTP code</span>
        </div>

        <ion-button expand="block" type="submit" [disabled]="resetPasswordForm.get('otp')?.invalid || isLoading" class="auth-button">
          <span *ngIf="!isLoading">Verify & Continue</span>
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        </ion-button>
      </form>

      <div class="auth-footer">
        <p>Didn't receive OTP? <a (click)="sendOtp(mobileNumber!)">Resend</a></p>
        <p><a (click)="switchMode('register')">Back to Registration</a></p>
      </div>
    </div>
  </div>
</ion-content>